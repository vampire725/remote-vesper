# ğŸ› ï¸ Elasticsearch è¾…åŠ©è„šæœ¬è¯´æ˜

> ğŸ“‹ æœ¬ç›®å½•åŒ…å«äº†ç”¨äºç®¡ç†å’Œç»´æŠ¤ Elasticsearch é›†ç¾¤çš„å®ç”¨è„šæœ¬å·¥å…·ã€‚

## ğŸ“– ç›®å½•

- [ğŸ“ è„šæœ¬æ¦‚è§ˆ](#-è„šæœ¬æ¦‚è§ˆ)
- [ğŸ” setup-certs.sh](#-setup-certssh)
- [ğŸ”‘ setup-passwords.sh](#-setup-passwordssh)
- [ğŸ” check-ports.sh](#-check-portssh)
- [ğŸš€ ä½¿ç”¨æµç¨‹](#-ä½¿ç”¨æµç¨‹)
- [âš ï¸ æ³¨æ„äº‹é¡¹](#ï¸-æ³¨æ„äº‹é¡¹)
- [ğŸ”§ æ•…éšœæ’é™¤](#-æ•…éšœæ’é™¤)

## ğŸ“ è„šæœ¬æ¦‚è§ˆ

| è„šæœ¬åç§°               | åŠŸèƒ½æè¿°      | ä½¿ç”¨åœºæ™¯          | ä¾èµ–æ¡ä»¶             |
| ---------------------- | ------------- | ----------------- | -------------------- |
| **setup-certs.sh**     | ç”Ÿæˆ SSL è¯ä¹¦ | é¦–æ¬¡éƒ¨ç½²/è¯ä¹¦æ›´æ–° | Docker               |
| **setup-passwords.sh** | è®¾ç½®ç”¨æˆ·å¯†ç   | å®‰å…¨é…ç½®          | Elasticsearch è¿è¡Œä¸­ |
| **check-ports.sh**     | æ£€æŸ¥ç«¯å£å†²çª  | éƒ¨ç½²å‰æ£€æŸ¥        | ç³»ç»Ÿå‘½ä»¤             |

## ğŸ” setup-certs.sh

### ğŸ“‹ **åŠŸèƒ½è¯´æ˜**

è‡ªåŠ¨ç”Ÿæˆ Elasticsearch é›†ç¾¤æ‰€éœ€çš„ SSL è¯ä¹¦ï¼ŒåŒ…æ‹¬ CA è¯ä¹¦å’Œå„èŠ‚ç‚¹è¯ä¹¦ã€‚

### ğŸ¯ **ä¸»è¦åŠŸèƒ½**

- ğŸ›ï¸ ç”Ÿæˆ CA æ ¹è¯ä¹¦
- ğŸ”‘ ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç”Ÿæˆç‹¬ç«‹è¯ä¹¦
- ğŸ”„ è‡ªåŠ¨è½¬æ¢è¯ä¹¦æ ¼å¼ï¼ˆPKCS12 â†’ PEMï¼‰
- ğŸ”’ è®¾ç½®åˆé€‚çš„æ–‡ä»¶æƒé™

### ğŸ’» **ä½¿ç”¨æ–¹æ³•**

```bash
# è¿›å…¥ es ç›®å½•
cd es

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/setup-certs.sh

# è¿è¡Œè„šæœ¬
./scripts/setup-certs.sh
```

### ğŸ“ **ç”Ÿæˆçš„æ–‡ä»¶**

```
certs/
â”œâ”€â”€ ca/
â”‚   â”œâ”€â”€ ca.p12          # CA è¯ä¹¦ï¼ˆPKCS12 æ ¼å¼ï¼‰
â”‚   â””â”€â”€ ca.crt          # CA è¯ä¹¦ï¼ˆPEM æ ¼å¼ï¼‰
â”œâ”€â”€ es01/
â”‚   â”œâ”€â”€ es01.p12        # èŠ‚ç‚¹1 è¯ä¹¦ï¼ˆPKCS12 æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ es01.crt        # èŠ‚ç‚¹1 è¯ä¹¦ï¼ˆPEM æ ¼å¼ï¼‰
â”‚   â””â”€â”€ es01.key        # èŠ‚ç‚¹1 ç§é’¥
â”œâ”€â”€ es02/
â”‚   â”œâ”€â”€ es02.p12        # èŠ‚ç‚¹2 è¯ä¹¦ï¼ˆPKCS12 æ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ es02.crt        # èŠ‚ç‚¹2 è¯ä¹¦ï¼ˆPEM æ ¼å¼ï¼‰
â”‚   â””â”€â”€ es02.key        # èŠ‚ç‚¹2 ç§é’¥
â””â”€â”€ es03/
    â”œâ”€â”€ es03.p12        # èŠ‚ç‚¹3 è¯ä¹¦ï¼ˆPKCS12 æ ¼å¼ï¼‰
    â”œâ”€â”€ es03.crt        # èŠ‚ç‚¹3 è¯ä¹¦ï¼ˆPEM æ ¼å¼ï¼‰
    â””â”€â”€ es03.key        # èŠ‚ç‚¹3 ç§é’¥
```

### âš ï¸ **æ³¨æ„äº‹é¡¹**

- ğŸ³ éœ€è¦ Docker è¿è¡Œç¯å¢ƒ
- ğŸ“ ä¼šè‡ªåŠ¨åˆ›å»º `certs` ç›®å½•
- ğŸ”’ ç§é’¥æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600
- â±ï¸ è¯ä¹¦é»˜è®¤æœ‰æ•ˆæœŸä¸º 3 å¹´

---

## ğŸ”‘ setup-passwords.sh

### ğŸ“‹ **åŠŸèƒ½è¯´æ˜**

ä¸º Elasticsearch å†…ç½®ç”¨æˆ·è®¾ç½®å¯†ç ï¼Œå¹¶åˆ›å»º Logstash ä¸“ç”¨ç”¨æˆ·å’Œè§’è‰²ã€‚

### ğŸ¯ **ä¸»è¦åŠŸèƒ½**

- ğŸ” è®¾ç½® `elastic` è¶…çº§ç”¨æˆ·å¯†ç 
- ğŸ‘¤ è®¾ç½® `kibana_system` ç”¨æˆ·å¯†ç 
- ğŸ”§ è®¾ç½® `logstash_system` ç”¨æˆ·å¯†ç 
- ğŸ“ åˆ›å»º `logstash_writer` è§’è‰²
- ğŸ‘¥ åˆ›å»ºä¸“ç”¨ `logstash` ç”¨æˆ·

### ğŸ’» **ä½¿ç”¨æ–¹æ³•**

```bash
# ç¡®ä¿ Elasticsearch å·²å¯åŠ¨
docker-compose up -d

# ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨ï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰
docker-compose logs -f es01

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/setup-passwords.sh

# è¿è¡Œè„šæœ¬
./scripts/setup-passwords.sh
```

### ğŸ” **åˆ›å»ºçš„ç”¨æˆ·å’Œè§’è‰²**

#### **å†…ç½®ç”¨æˆ·**

| ç”¨æˆ·å            | è§’è‰²            | ç”¨é€”              |
| ----------------- | --------------- | ----------------- |
| `elastic`         | superuser       | è¶…çº§ç®¡ç†å‘˜        |
| `kibana_system`   | kibana_system   | Kibana ç³»ç»Ÿç”¨æˆ·   |
| `logstash_system` | logstash_system | Logstash ç³»ç»Ÿç”¨æˆ· |

#### **è‡ªå®šä¹‰ç”¨æˆ·**

| ç”¨æˆ·å     | è§’è‰²            | ç”¨é€”              |
| ---------- | --------------- | ----------------- |
| `logstash` | logstash_writer | Logstash æ•°æ®å†™å…¥ |

#### **è‡ªå®šä¹‰è§’è‰²æƒé™**

```json
{
  "logstash_writer": {
    "cluster": ["manage_index_templates", "monitor", "manage_ilm"],
    "indices": [
      {
        "names": ["logstash-*"],
        "privileges": [
          "write",
          "create",
          "create_index",
          "manage",
          "manage_ilm"
        ]
      }
    ]
  }
}
```

### âš ï¸ **æ³¨æ„äº‹é¡¹**

- ğŸš€ éœ€è¦ Elasticsearch æœåŠ¡è¿è¡Œä¸­
- ğŸ” å¯†ç è¾“å…¥æ—¶ä¸ä¼šæ˜¾ç¤ºå­—ç¬¦
- ğŸ“ è®°å½•å¥½è®¾ç½®çš„å¯†ç 
- ğŸ”„ è®¾ç½®åéœ€è¦é‡å¯æœåŠ¡åº”ç”¨æ–°å¯†ç 

---

## ğŸ” check-ports.sh

### ğŸ“‹ **åŠŸèƒ½è¯´æ˜**

æ£€æŸ¥ Elasticsearch å’Œ Kibana æ‰€éœ€ç«¯å£æ˜¯å¦è¢«å ç”¨ï¼Œå¹¶è¿›è¡Œç³»ç»Ÿèµ„æºæ£€æŸ¥ã€‚

### ğŸ¯ **ä¸»è¦åŠŸèƒ½**

- ğŸ” æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µï¼ˆ9200, 9300, 5601ï¼‰
- ğŸ³ æ£€æŸ¥ Docker å®¹å™¨ç«¯å£å ç”¨
- ğŸ’¾ æ£€æŸ¥ç³»ç»Ÿå†…å­˜èµ„æº
- ğŸ’¿ æ£€æŸ¥ç£ç›˜ç©ºé—´
- ğŸ–¥ï¸ è·¨å¹³å°æ”¯æŒï¼ˆLinux/macOS/Windowsï¼‰

### ğŸ’» **ä½¿ç”¨æ–¹æ³•**

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/check-ports.sh

# è¿è¡Œæ£€æŸ¥
./scripts/check-ports.sh
```

### ğŸ“Š **æ£€æŸ¥é¡¹ç›®**

#### **ç«¯å£æ£€æŸ¥**

| ç«¯å£ | æœåŠ¡          | ç”¨é€”       |
| ---- | ------------- | ---------- |
| 9200 | Elasticsearch | HTTP API   |
| 9300 | Elasticsearch | ä¼ è¾“å±‚é€šä¿¡ |
| 5601 | Kibana        | Web ç•Œé¢   |

#### **ç³»ç»Ÿèµ„æºæ£€æŸ¥**

- ğŸ’¾ **å†…å­˜æ£€æŸ¥**: æ€»å†…å­˜å’Œå¯ç”¨å†…å­˜
- ğŸ’¿ **ç£ç›˜æ£€æŸ¥**: å½“å‰ç›®å½•å¯ç”¨ç©ºé—´
- ğŸ³ **Docker æ£€æŸ¥**: Docker æœåŠ¡çŠ¶æ€

### ğŸ”§ **è§£å†³ç«¯å£å†²çª**

#### **Linux ç³»ç»Ÿ**

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tlnp | grep :9200

# æ€æ­»å ç”¨è¿›ç¨‹
sudo kill -9 <è¿›ç¨‹ID>
```

#### **macOS ç³»ç»Ÿ**

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
lsof -i :9200

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <è¿›ç¨‹ID>
```

#### **Windows ç³»ç»Ÿ**

```cmd
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -an | findstr :9200

# åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­ç»“æŸç›¸å…³è¿›ç¨‹
```

### âš ï¸ **æ³¨æ„äº‹é¡¹**

- ğŸ–¥ï¸ æ”¯æŒå¤šç§æ“ä½œç³»ç»Ÿ
- ğŸ” ä¼šæ˜¾ç¤ºå ç”¨è¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯
- âš¡ å‘ç°å†²çªæ—¶è„šæœ¬ä¼šä»¥é”™è¯¯ç é€€å‡º
- ğŸ’¡ æä¾›å…·ä½“çš„è§£å†³å»ºè®®

---

## ğŸš€ ä½¿ç”¨æµç¨‹

### ğŸ“‹ **å®Œæ•´éƒ¨ç½²æµç¨‹**

```bash
# 1. è¿›å…¥ es ç›®å½•
cd es

# 2. æ£€æŸ¥ç«¯å£å’Œç³»ç»Ÿèµ„æº
chmod +x scripts/check-ports.sh
./scripts/check-ports.sh

# 3. ç”Ÿæˆ SSL è¯ä¹¦
chmod +x scripts/setup-certs.sh
./scripts/setup-certs.sh

# 4. åˆ›å»º Docker ç½‘ç»œ
docker network create logging-network
docker network create monitoring-network

# 5. å¯åŠ¨ Elasticsearch é›†ç¾¤
docker-compose up -d

# 6. ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆ
docker-compose logs -f es01

# 7. è®¾ç½®ç”¨æˆ·å¯†ç 
chmod +x scripts/setup-passwords.sh
./scripts/setup-passwords.sh

# 8. éªŒè¯éƒ¨ç½²
curl -k -u elastic:your_password https://localhost:9200/_cluster/health
```

### ğŸ”„ **ç»´æŠ¤æµç¨‹**

#### **è¯ä¹¦æ›´æ–°**

```bash
# å¤‡ä»½æ—§è¯ä¹¦
cp -r certs certs.backup.$(date +%Y%m%d)

# é‡æ–°ç”Ÿæˆè¯ä¹¦
./scripts/setup-certs.sh

# é‡å¯æœåŠ¡
docker-compose restart
```

#### **å¯†ç é‡ç½®**

```bash
# é‡æ–°è®¾ç½®å¯†ç 
./scripts/setup-passwords.sh

# æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç 
# é‡å¯ç›¸å…³æœåŠ¡
```

#### **ç«¯å£å†²çªè§£å†³**

```bash
# æ£€æŸ¥ç«¯å£çŠ¶æ€
./scripts/check-ports.sh

# æ ¹æ®æç¤ºè§£å†³å†²çª
# é‡æ–°å¯åŠ¨æœåŠ¡
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### ğŸ”’ **å®‰å…¨æ³¨æ„äº‹é¡¹**

1. **è¯ä¹¦å®‰å…¨**:

   - ğŸ” ç§é’¥æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600
   - ğŸ“ è¯ä¹¦ç›®å½•ä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
   - ğŸ”„ å®šæœŸæ›´æ–°è¯ä¹¦ï¼ˆå»ºè®®æ¯å¹´ï¼‰

2. **å¯†ç å®‰å…¨**:

   - ğŸ” ä½¿ç”¨å¼ºå¯†ç ï¼ˆè‡³å°‘ 8 ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼‰
   - ğŸ“ å®‰å…¨å­˜å‚¨å¯†ç ï¼ˆä½¿ç”¨å¯†ç ç®¡ç†å™¨ï¼‰
   - ğŸ”„ å®šæœŸæ›´æ¢å¯†ç 

3. **æƒé™ç®¡ç†**:
   - ğŸ‘¤ éµå¾ªæœ€å°æƒé™åŸåˆ™
   - ğŸ” å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™
   - ğŸ“Š ç›‘æ§ç”¨æˆ·æ´»åŠ¨

### ğŸ’¾ **æ•°æ®å®‰å…¨**

1. **å¤‡ä»½ç­–ç•¥**:

   - ğŸ“… å®šæœŸå¤‡ä»½è¯ä¹¦å’Œé…ç½®
   - ğŸ’¾ å¤‡ä»½ Elasticsearch æ•°æ®
   - ğŸ”„ æµ‹è¯•æ¢å¤æµç¨‹

2. **ç›‘æ§å‘Šè­¦**:
   - ğŸ“Š ç›‘æ§æœåŠ¡çŠ¶æ€
   - ğŸš¨ è®¾ç½®èµ„æºä½¿ç”¨å‘Šè­¦
   - ğŸ“ˆ ç›‘æ§æ€§èƒ½æŒ‡æ ‡

### ğŸ–¥ï¸ **ç³»ç»Ÿè¦æ±‚**

1. **æ“ä½œç³»ç»Ÿå…¼å®¹æ€§**:

   - âœ… Linux (æ¨è)
   - âœ… macOS
   - âœ… Windows (WSL æ¨è)

2. **ä¾èµ–è½¯ä»¶**:
   - ğŸ³ Docker 20.10+
   - ğŸ”§ Docker Compose 2.0+
   - ğŸŒ curl (ç”¨äº API æµ‹è¯•)

---

## ğŸ”§ æ•…éšœæ’é™¤

### âŒ **å¸¸è§é—®é¢˜**

#### **1. è¯ä¹¦ç”Ÿæˆå¤±è´¥**

```bash
# é—®é¢˜ï¼šDocker é•œåƒæ‹‰å–å¤±è´¥
# è§£å†³ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œä½¿ç”¨é•œåƒåŠ é€Ÿå™¨

# é—®é¢˜ï¼šæƒé™ä¸è¶³
# è§£å†³ï¼šç¡®ä¿å½“å‰ç”¨æˆ·æœ‰ Docker æƒé™
sudo usermod -aG docker $USER
```

#### **2. å¯†ç è®¾ç½®å¤±è´¥**

```bash
# é—®é¢˜ï¼šElasticsearch æœªå¯åŠ¨
# è§£å†³ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
docker-compose logs es01

# é—®é¢˜ï¼šé»˜è®¤å¯†ç é”™è¯¯
# è§£å†³ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
grep ELASTIC_PASSWORD docker-compose.yaml
```

#### **3. ç«¯å£æ£€æŸ¥å¼‚å¸¸**

```bash
# é—®é¢˜ï¼šå‘½ä»¤ä¸å­˜åœ¨
# è§£å†³ï¼šå®‰è£…å¿…è¦å·¥å…·
# Ubuntu/Debian
sudo apt-get install net-tools

# CentOS/RHEL
sudo yum install net-tools

# macOS
# é€šå¸¸å·²é¢„è£…ï¼Œå¦‚æœ‰é—®é¢˜å¯é‡æ–°å®‰è£… Xcode Command Line Tools
```

### ğŸ†˜ **è·å–å¸®åŠ©**

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. ğŸ“– æŸ¥çœ‹ [Elasticsearch å®˜æ–¹æ–‡æ¡£](https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html)
2. ğŸ” æ£€æŸ¥ Docker å®¹å™¨æ—¥å¿—ï¼š`docker-compose logs -f`
3. ğŸ’¬ åœ¨é¡¹ç›® Issue ä¸­æé—®
4. ğŸ“§ è”ç³»æŠ€æœ¯æ”¯æŒ

---

**ğŸ’¡ æç¤º**: å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯æ‰€æœ‰è„šæœ¬çš„åŠŸèƒ½ï¼
